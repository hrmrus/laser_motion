#include <Arduino.h>

#define pinPhoto   A0 // Фоторезистор на порту...
#define pinPhoto2  A1 // Фоторезистор на порту...
#define led        13 // Реле на порту...
#define led2       12 // Лазер на порту...

int raw[2]  = {0,0};
int raw2[2] = {0,0};

boolean IR1_state = 0;
boolean IR2_state = 0;
boolean IR1_already=0;
boolean IR2_already=0;
boolean IR1IR2_already=0;

int  IR1IR2_first=0;
int Human_Counter_New=0;
int Human_Counter_Old=0;

void setup() {
  pinMode( pinPhoto, INPUT );
  pinMode( pinPhoto2, INPUT );
  pinMode( led, OUTPUT );
  pinMode( led2, OUTPUT );
}
void loop() {
  // Включить лазер
  digitalWrite(led2, HIGH);
  delay(20);
  // Замерить сопротивление датчиков и записать их в масив
  raw[0]  = analogRead( pinPhoto );
  raw2[0] = analogRead( pinPhoto2);
  // Выключить лазер
  digitalWrite(led2, LOW);
  delay(20);
  // Замерить сопротивление датчиков и записать их в масив
  raw[1]  = analogRead( pinPhoto );
  raw2[1] = analogRead( pinPhoto2);

/**********************************/
// Необходимо подобрать разницу значений
// Для примера я поставил если разница  больше 50, то нет препятствия.
// Если разница меньше 40, то  есть препятствие.

 /* преременной IR1_state присваиваем 0 или 1 в
  зависимости от показаний фоторезистора raw */
  if( (raw[0] -  raw[1]) > 200){ //
    IR1_state = 0;}
  if( (raw[0] -  raw[1]) < 150){
    IR1_state = 1;}

/**********************************/
 /* преременной fr2 присваиваем 0 или 1 в
  зависимости от показаний фоторезистора raw */
   if( (raw2[0] -  raw2[1]) > 200){
    IR2_state = 0;}
   if( (raw2[0] -  raw2[1]) < 150){ //
    IR2_state = 1;}


/**************************************/

if ( !IR1_state && !IR2_state) // IR1 off, IR2 off.
  {
      if ( IR1IR2_first > 0 && IR1IR2_already && IR1_already && IR2_already)
    {
      if ( IR1IR2_first == 1) {
        Human_Counter_New++;
      }
      else {
        Human_Counter_New--;
      }
       }

    IR1_already = 0;
    IR2_already = 0;
    IR1IR2_already = 0;
    IR1IR2_first = 0;
  }
  if ( IR1_state && !IR2_state) // IR1 on, IR2 off.
  {
    IR1_already = 1;
    if ( !IR2_already ) {
      IR1IR2_first = 1;
    }
   }
  if ( !IR1_state && IR2_state) // IR1 off, IR2 on.
  {
    IR2_already = 1;
    if ( !IR1_already ) {
      IR1IR2_first = 2;
   }
  }
  if ( IR1_state && IR2_state) // IR1 on, IR2 on.
  {
    IR1IR2_already = 1;
    }
  if ( Human_Counter_New < 0 ) {
    Human_Counter_New = 0;
  }
    if ( Human_Counter_New != Human_Counter_Old )
  {
    Human_Counter_Old = Human_Counter_New;
  }

/**************************************/
  if( Human_Counter_New  > 0)
    digitalWrite( led, HIGH );

  else
    digitalWrite( led, LOW );
}
